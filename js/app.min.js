function getToken(params){return $.ajax({url:SERVER_URL+"/api/linkedin/token",type:"GET",data:params})}function getProfile(token){return $.ajax({url:SERVER_URL+"/api/linkedin/profile?token="+token,type:"POST"})}function addLocation(linkedinId,lat,lng){return $.ajax({url:SERVER_URL+"/api/user/"+linkedinId+"/location",type:"POST",data:{lat:lat,lng:lng}})}function getLocation(success,fail){navigator.geolocation.getCurrentPosition(function(pos){var crd=pos.coords,lati=crd.latitude,longi=crd.longitude;crd.accuracy;addLocation(profileLinkedinId,lati,longi).then(function(res){console.log("Location updated"),success&&success({lat:lati,lng:longi},res)})},function(err){fail&&fail(err),console.warn("ERROR("+err.code+"): "+err.message)})}function sendInivation(senderLinkedinId,receiverLinkedinId){$.ajax({method:"POST",url:SERVER_URL+"/api/user/"+senderLinkedinId+"/friends/"+receiverLinkedinId}).then(function(response){alert("invitation sent! :)")},function(response){"A pending request already exists"==response.responseJSON.errorMessage?alert("invitation pending for confirmation :)"):"Requester and requested are already friends"==response.responseJSON.errorMessage?alert("You are already connected! :)"):alert("Something goes wrong :( try again later!")})}function getPendingAndFriends(linkedinId,callback){$.ajax({method:"GET",url:SERVER_URL+"/api/user/"+linkedinId+"/friends/requests"}).then(function(response){pending=response.received,$.ajax({method:"GET",url:SERVER_URL+"/api/user/"+linkedinId+"/friends"}).then(function(response){friends=response.friends,callback()})})}var nameApp=angular.module("starter",["ionic","ui.router"]),REDIRECT_URL="https://lynking.github.io",CLIENT_ID="81xcrsa3u39vr4",CLIENT_SECRET="2P3itf8w1G5kgnY9",TOKEN_STATE="lynking123",SERVER_URL="https://4113studio.com",profileLinkedinId="",profilePictureUrl="",receiverAvatar="",receiverName="",receiverHeadLine="",receiverDistance="",receiverSummary="",receiverLinkedinId="",friends=[],pending=[],socket=io(SERVER_URL);socket.on("notification",function(data){console.log(data),data.receiver==profileLinkedinId&&(document.getElementsByClassName("chat-list-btn")[0].style.backgroundImage="url('../img/chat-new.png')")}),nameApp.factory("sharedData",function(){return{profile:{},friend:{},matchedList:[]}}),nameApp.directive("ngMobileClick",[function(){return function(scope,elem,attrs){elem.bind("touchstart click",function(e){e.preventDefault(),e.stopPropagation(),scope.$apply(attrs.ngMobileClick)})}}]),nameApp.directive("ngKeyEnter",function(){return function(scope,element,attrs){element.bind("keyup",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngKeyEnter)}),event.preventDefault())})}}),nameApp.run(function(){window.StatusBar&&StatusBar.styleBlackTranslucent()}),nameApp.config(function($stateProvider,$urlRouterProvider){$stateProvider.state("index",{url:"/",templateUrl:"index.html",controller:"IndexCtrl"}).state("search",{url:"/search",templateUrl:"search.html",controller:"SearchCtrl"}).state("candidates",{url:"/candidates",templateUrl:"candidates.html",controller:"CandidatesCtrl"}).state("details",{url:"/details",templateUrl:"details.html",controller:"DetailsCtrl"}).state("chat",{url:"/chat/:linkedinId/:friendLinkedinId",templateUrl:"chat.html",controller:"ChatCtrl"}).state("chatList",{url:"/chatList",templateUrl:"chatList.html",controller:"ChatListCtrl"}),$urlRouterProvider.otherwise("/")}),nameApp.controller("IndexCtrl",function($scope,$state,sharedData){$scope.redirect=function(){var linkedAuthUrl="https://www.linkedin.com/oauth/v2/authorization?response_type=code";linkedAuthUrl+="&client_id="+CLIENT_ID,linkedAuthUrl+="&redirect_uri="+encodeURIComponent(REDIRECT_URL),linkedAuthUrl+="&state="+TOKEN_STATE,location.href=linkedAuthUrl},console.log(window.location.href);var currentURL=window.location.href;if(currentURL.indexOf("code")>-1){var start=currentURL.indexOf("code"),end=currentURL.indexOf("state"),code=currentURL.substring(start+5,end-1),reqBody={grant_type:"authorization_code",code:code,redirect_uri:REDIRECT_URL,client_id:CLIENT_ID,client_secret:CLIENT_SECRET};getToken(reqBody).then(function(data){return getProfile(data.access_token)}).then(function(profile){console.log("profile",profile),$state.go("search"),profileLinkedinId=profile.linkedinId,profilePictureUrl=profile.pictureUrl,profileName=profile.formattedName,sharedData.profile=profile})}$scope.changePage=function(){$state.go("search")}}),nameApp.controller("SearchCtrl",function($scope,$state,$ionicHistory){$scope.goBack=function(){$ionicHistory.goBack()},document.getElementById("avatar").setAttribute("src",profilePictureUrl),getLocation(function(){console.info("location updated"),$state.go("candidates")},function(){var needRefresh=confirm("Failed to get Location, Want to refresh ?");needRefresh&&location.reload(),console.error("location error")})}),nameApp.controller("CandidatesCtrl",function($scope,$http,$state,$ionicHistory,$ionicSlideBoxDelegate,sharedData,$ionicViewSwitcher){$scope.goBack=function(){$ionicHistory.goBack()},$scope.goBackToHome=function(){$ionicViewSwitcher.nextDirection("back"),$state.go("index")},$scope.go=function(path){$location.path(path)};var curProfile=sharedData.profile;if(!curProfile.linkedinId)return alert("Need login"),$ionicViewSwitcher.nextDirection("back"),void $state.go("index");$scope.jumpToChatList=function(){getPendingAndFriends(profileLinkedinId,function(){document.getElementsByClassName("chat-list-btn")[0].style.backgroundImage="url('../img/chat.png')",$state.go("chatList")})},$.ajax({method:"GET",url:SERVER_URL+"/api/user/"+curProfile.linkedinId+"/match?distance=1500"}).then(function(response){$scope.personsList=response.users,sharedData.matchedList=response.users},function(response){console.log("data not get")}),document.getElementById("posi-btn").onclick=function(){getLocation(function(){console.info("location updated"),alert("location updated!")},function(){console.error("location error")})},$scope.data={},$scope.data.currentPage=0;var setupSlider=function(){$scope.data.sliderOptions={initialSlide:0,direction:"horizontal",speed:300,pagination:!1}};setupSlider(),document.getElementById("nope-btn").onclick=function(){$scope.data.sliderDelegate.slideNext()},document.getElementById("yeah-btn").onclick=function(){receiverLinkedinId=document.getElementsByClassName("swiper-slide-active")[0].getElementsByClassName("uid")[0].innerHTML,sendInivation(profileLinkedinId,receiverLinkedinId)},$scope.lookDetail=function(index){sharedData.friend=sharedData.matchedList[index],receiverLinkedinId=document.getElementsByClassName("swiper-slide-active")[0].getElementsByClassName("uid")[0].innerHTML,$state.go("details")}}),nameApp.controller("DetailsCtrl",function($scope,$state,$ionicHistory,sharedData){$scope.goBack=function(){$ionicHistory.goBack()},$scope.jumpToChatList=function(){getPendingAndFriends(profileLinkedinId,function(){document.getElementsByClassName("chat-list-btn")[0].style.backgroundImage="url('../img/chat.png')",$state.go("chatList")})};var friend=(sharedData.profile,sharedData.friend);$scope.personDetail=friend,document.getElementById("yeah-detail-btn").onclick=function(){sendInivation(profileLinkedinId,receiverLinkedinId)}}),nameApp.controller("ChatListCtrl",function($scope,$state,$ionicHistory,sharedData){$scope.goBack=function(){$ionicHistory.goBack()};var profile=sharedData.profile;$scope.pendingList=pending,$scope.friendsList=friends,$scope.acceptReq=function($event){var btns=angular.element($event.target).parent()[0],friendLinkedinId=btns.parentElement.getElementsByClassName("linkedinId")[0].innerHTML;$.ajax({method:"PUT",url:SERVER_URL+"/api/user/"+profile.linkedinId+"/friends/"+friendLinkedinId,data:{action:"accept"}}).then(function(response){btns.getElementsByClassName("accept-btn")[0].style.display="none",btns.getElementsByClassName("reject-btn")[0].style.display="none",btns.getElementsByClassName("gochat-btn")[0].style.display="block"},function(response){alert("please try again later")})},$scope.rejectReq=function($event){var listItem=angular.element($event.target).parent()[0].parentElement,friendLinkedinId=listItem.getElementsByClassName("linkedinId")[0].innerHTML;$.ajax({method:"PUT",url:SERVER_URL+"/api/user/"+profileLinkedinId+"/friends/"+friendLinkedinId,data:{action:"deny"}}).then(function(response){listItem.style.display="none"},function(response){alert("please try again later")})},$scope.goChat=function(friend){$state.go("chat",{linkedinId:profile.linkedinId,friendLinkedinId:friend.linkedinId})}}),nameApp.controller("ChatCtrl",function($scope,$state,$ionicHistory,sharedData){function refreshMessage(data){var val=data.val();$scope.messages.push(val),$scope.$apply()}var uid=$state.params.linkedinId,friendId=$state.params.friendLinkedinId;if($scope.messages=[],$scope.input={text:""},$scope.curProfile=sharedData.profile,!firebase.apps.length){var config={apiKey:"AIzaSyBst2CUBQYUJZZ8eEg-KhcgSi8L_P6tJVs",authDomain:"lynking-33fb0.firebaseapp.com",databaseURL:"https://lynking-33fb0.firebaseio.com",storageBucket:"lynking-33fb0.appspot.com",messagingSenderId:"489592513195"};firebase.initializeApp(config)}$.ajax({method:"POST",url:SERVER_URL+"/api/user/"+uid+"/chatToken"}).then(function(res){$scope.auth=firebase.auth().signInWithCustomToken(res.chatToken);var dbRef=firebase.database().ref("chats/"+uid+"/"+friendId),dbRefCopy=firebase.database().ref("chats/"+friendId+"/"+uid);dbRef.off(),dbRef.limitToLast(20).on("child_added",refreshMessage),$scope.dbRef=dbRef,$scope.dbRefCopy=dbRefCopy}).fail(function(err){alert(err.responseJSON.errorMessage)}),$scope.goBack=function(){$ionicHistory.goBack()},$scope.sendMessage=function(){var text=$scope.input.text;if(null!==text&&""!==text){var curProfile=sharedData.profile,message={linkedinId:uid,text:text,photoUrl:curProfile.pictureUrl,name:curProfile.formattedName,timestamp:Date.now()};$scope.dbRef.push(message),$scope.dbRefCopy.push(message),$scope.input.text=""}}});