function getToken(e){return $.ajax({url:SERVER_URL+"/api/linkedin/token",type:"GET",data:e})}function getProfile(e){return $.ajax({url:SERVER_URL+"/api/linkedin/profile?token="+e,type:"POST"})}function addLocation(e,n,t){return $.ajax({url:SERVER_URL+"/api/user/"+e+"/location",type:"POST",data:{lat:n,lng:t}})}function getLocation(e,n){navigator.geolocation.getCurrentPosition(function(n){var t=n.coords,i=t.latitude,a=t.longitude;t.accuracy;addLocation(profileLinkedinId,i,a).then(function(n){console.log("Location updated"),e&&e({lat:i,lng:a},n)})},function(e){n&&n(e),console.warn("ERROR("+e.code+"): "+e.message)})}function sendInivation(e,n){$.ajax({method:"POST",url:SERVER_URL+"/api/user/"+e+"/friends/"+n}).then(function(e){alert("invitation sent! :)")},function(e){"A pending request already exists"==e.responseJSON.errorMessage?alert("invitation pending for confirmation :)"):"Requester and requested are already friends"==e.responseJSON.errorMessage?alert("You are already connected! :)"):alert("Something goes wrong :( try again later!")})}function getPendingAndFriends(e,n){$.ajax({method:"GET",url:SERVER_URL+"/api/user/"+e+"/friends/requests"}).then(function(t){pending=t.received,$.ajax({method:"GET",url:SERVER_URL+"/api/user/"+e+"/friends"}).then(function(e){friends=e.friends,n()})})}var nameApp=angular.module("starter",["ionic","ui.router"]),REDIRECT_URL="https://lynking.github.io",CLIENT_ID="81xcrsa3u39vr4",CLIENT_SECRET="2P3itf8w1G5kgnY9",TOKEN_STATE="lynking123",SERVER_URL="https://4113studio.com",profileLinkedinId="",profilePictureUrl="",receiverAvatar="",receiverName="",receiverHeadLine="",receiverDistance="",receiverSummary="",receiverLinkedinId="",friends=[],pending=[],socket=io(SERVER_URL);socket.on("notification",function(e){console.log(e),e.receiver==profileLinkedinId&&(document.getElementsByClassName("chat-list-btn")[0].style.backgroundImage="url('../img/chat-new.png')")}),nameApp.factory("sharedData",function(){return{profile:{},friend:{},matchedList:[]}}),nameApp.directive("ngMobileClick",[function(){return function(e,n,t){n.bind("touchstart click",function(n){n.preventDefault(),n.stopPropagation(),e.$apply(t.ngMobileClick)})}}]),nameApp.directive("ngKeyEnter",function(){return function(e,n,t){n.bind("keyup",function(n){13===n.which&&(e.$apply(function(){e.$eval(t.ngKeyEnter)}),n.preventDefault())})}}),nameApp.run(function(){window.StatusBar&&StatusBar.styleBlackTranslucent()}),nameApp.config(function(e,n){e.state("index",{url:"/",templateUrl:"index.html",controller:"IndexCtrl"}).state("search",{url:"/search",templateUrl:"search.html",controller:"SearchCtrl"}).state("candidates",{url:"/candidates",templateUrl:"candidates.html",controller:"CandidatesCtrl"}).state("details",{url:"/details",templateUrl:"details.html",controller:"DetailsCtrl"}).state("chat",{url:"/chat/:linkedinId/:friendLinkedinId",templateUrl:"chat.html",controller:"ChatCtrl"}).state("chatList",{url:"/chatList",templateUrl:"chatList.html",controller:"ChatListCtrl"}),n.otherwise("/")}),nameApp.controller("IndexCtrl",function(e,n,t){e.redirect=function(){var e="https://www.linkedin.com/oauth/v2/authorization?response_type=code";e+="&client_id="+CLIENT_ID,e+="&redirect_uri="+encodeURIComponent(REDIRECT_URL),e+="&state="+TOKEN_STATE,location.href=e},console.log(window.location.href);var i=window.location.href;if(i.indexOf("code")>-1){var a=i.indexOf("code"),o=i.indexOf("state"),r=i.substring(a+5,o-1),l={grant_type:"authorization_code",code:r,redirect_uri:REDIRECT_URL,client_id:CLIENT_ID,client_secret:CLIENT_SECRET};getToken(l).then(function(e){return getProfile(e.access_token)}).then(function(e){console.log("profile",e),n.go("search"),profileLinkedinId=e.linkedinId,profilePictureUrl=e.pictureUrl,profileName=e.formattedName,t.profile=e})}e.changePage=function(){n.go("search")}}),nameApp.controller("SearchCtrl",function(e,n,t){e.goBack=function(){t.goBack()},document.getElementById("avatar").setAttribute("src",profilePictureUrl),getLocation(function(){console.info("location updated"),n.go("candidates")},function(){var e=confirm("Failed to get Location, Want to refresh ?");e&&location.reload(),console.error("location error")})}),nameApp.controller("CandidatesCtrl",function(e,n,t,i,a,o,r){e.goBack=function(){i.goBack()},e.goBackToHome=function(){r.nextDirection("back"),t.go("index")},e.go=function(e){$location.path(e)};var l=o.profile;if(!l.linkedinId)return alert("Need login"),r.nextDirection("back"),void t.go("index");e.jumpToChatList=function(){getPendingAndFriends(profileLinkedinId,function(){document.getElementsByClassName("chat-list-btn")[0].style.backgroundImage="url('../img/chat.png')",t.go("chatList")})},$.ajax({method:"GET",url:SERVER_URL+"/api/user/"+l.linkedinId+"/match?distance=1500"}).then(function(n){e.personsList=n.users,o.matchedList=n.users},function(e){console.log("data not get")}),document.getElementById("posi-btn").onclick=function(){getLocation(function(){console.info("location updated"),alert("location updated!")},function(){console.error("location error")})},e.data={},e.data.currentPage=0;var c=function(){e.data.sliderOptions={initialSlide:0,direction:"horizontal",speed:300,pagination:!1}};c(),document.getElementById("nope-btn").onclick=function(){e.data.sliderDelegate.slideNext()},document.getElementById("yeah-btn").onclick=function(){receiverLinkedinId=document.getElementsByClassName("swiper-slide-active")[0].getElementsByClassName("uid")[0].innerHTML,sendInivation(profileLinkedinId,receiverLinkedinId)},e.lookDetail=function(e){o.friend=o.matchedList[e],receiverLinkedinId=document.getElementsByClassName("swiper-slide-active")[0].getElementsByClassName("uid")[0].innerHTML,t.go("details")}}),nameApp.controller("DetailsCtrl",function(e,n,t,i){e.goBack=function(){t.goBack()},e.jumpToChatList=function(){getPendingAndFriends(profileLinkedinId,function(){document.getElementsByClassName("chat-list-btn")[0].style.backgroundImage="url('../img/chat.png')",n.go("chatList")})};var a=(i.profile,i.friend);e.personDetail=a,document.getElementById("yeah-detail-btn").onclick=function(){sendInivation(profileLinkedinId,receiverLinkedinId)}}),nameApp.controller("ChatListCtrl",function(e,n,t,i){e.goBack=function(){t.goBack()};var a=i.profile;e.pendingList=pending,e.friendsList=friends,e.acceptReq=function(e){var n=angular.element(e.target).parent()[0],t=n.parentElement.getElementsByClassName("linkedinId")[0].innerHTML;$.ajax({method:"PUT",url:SERVER_URL+"/api/user/"+a.linkedinId+"/friends/"+t,data:{action:"accept"}}).then(function(e){n.getElementsByClassName("accept-btn")[0].style.display="none",n.getElementsByClassName("reject-btn")[0].style.display="none",n.getElementsByClassName("gochat-btn")[0].style.display="block"},function(e){alert("please try again later")})},e.rejectReq=function(e){var n=angular.element(e.target).parent()[0].parentElement,t=n.getElementsByClassName("linkedinId")[0].innerHTML;$.ajax({method:"PUT",url:SERVER_URL+"/api/user/"+profileLinkedinId+"/friends/"+t,data:{action:"deny"}}).then(function(e){n.style.display="none"},function(e){alert("please try again later")})},e.goChat=function(e){n.go("chat",{linkedinId:a.linkedinId,friendLinkedinId:e.linkedinId})}}),nameApp.controller("ChatCtrl",function(e,n,t,i){function a(n){var t=n.val();e.messages.push(t),e.$apply()}var o=n.params.linkedinId,r=n.params.friendLinkedinId;if(e.messages=[],e.input={text:""},e.curProfile=i.profile,!firebase.apps.length){var l={apiKey:"AIzaSyBst2CUBQYUJZZ8eEg-KhcgSi8L_P6tJVs",authDomain:"lynking-33fb0.firebaseapp.com",databaseURL:"https://lynking-33fb0.firebaseio.com",storageBucket:"lynking-33fb0.appspot.com",messagingSenderId:"489592513195"};firebase.initializeApp(l)}$.ajax({method:"POST",url:SERVER_URL+"/api/user/"+o+"/chatToken"}).then(function(n){e.auth=firebase.auth().signInWithCustomToken(n.chatToken);var t=firebase.database().ref("chats/"+o+"/"+r),i=firebase.database().ref("chats/"+r+"/"+o);t.off(),t.limitToLast(20).on("child_added",a),e.dbRef=t,e.dbRefCopy=i}).fail(function(e){alert(e.responseJSON.errorMessage)}),e.goBack=function(){t.goBack()},e.sendMessage=function(){var n=e.input.text;if(null!==n&&""!==n){var t=i.profile,a={linkedinId:o,text:n,photoUrl:t.pictureUrl,name:t.formattedName,timestamp:Date.now()};e.dbRef.push(a),e.dbRefCopy.push(a),e.input.text=""}}});